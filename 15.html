<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>إضافة فصل | MangaSanctum</title>
<style>
  body {margin:0;padding:0;background:radial-gradient(circle at top,#1c1b29,#0e0d16);font-family:"Segoe UI",sans-serif;color:#eee;}
  .container {max-width:650px;margin:50px auto;padding:25px;backdrop-filter:blur(18px);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:18px;box-shadow:0 0 25px rgba(120,80,255,0.25);}
  h1 {text-align:center;color:#bbaaff;font-weight:normal;}
  #searchBox {width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:10px;color:#eee;margin-bottom:12px;}
  #mangaList {max-height:200px;overflow-y:auto;margin-bottom:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);}
  .manga-item {padding:10px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:0.2s;}
  .manga-item:hover {background:rgba(140,120,255,0.15);}
  .selected {background:rgba(140,120,255,0.3);}
  .manga-item img {width:40px;height:40px;object-fit:cover;border-radius:6px;}
  label {display:block;margin-top:15px;}
  input,textarea {width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:10px;color:#eee;margin-top:8px;transition:0.3s;}
  input:focus,textarea:focus {border-color:#8b70ff;box-shadow:0 0 0 3px rgba(140,120,255,0.25);outline:none;}
  button {width:100%;margin-top:25px;padding:12px;font-size:17px;background:linear-gradient(135deg,#7d5cff,#6140ff);border:none;border-radius:12px;color:#fff;cursor:pointer;transition:0.3s;font-weight:bold;}
  button:disabled {opacity:0.4;cursor:not-allowed;}
  #status {margin-top:15px;text-align:center;color:#ccbaff;}
</style>
</head>
<body>

<div class="container">
  <h1>إضافة فصل جديد</h1>

  <input id="searchBox" type="text" placeholder="ابحث عن المانجا">
  <div id="mangaList"></div>

  <label>رقم الفصل</label>
  <input id="chapterNumber" type="text">

  <label>اسم الفصل</label>
  <input id="chapterName" type="text">

  <label>ملف الفصل</label>
  <input id="chapterFile" type="file">

  <button id="uploadBtn">رفع الفصل</button>
  <div id="status"></div>
</div>

<script>
let mangaData = [];
let selectedManga = null;
const searchBox = document.getElementById("searchBox");
const mangaListDiv = document.getElementById("mangaList");
const uploadBtn = document.getElementById("uploadBtn");

async function fetchMangaList(){
  try{
    const res = await fetch("https://script.google.com/macros/s/AKfycbwHfgxQjwS2UplSvV63XSReQN0Jt-q3YcmlZQ8Zd64Q5lesALQ1_JqiUWxhfn76_mHQAQ/exec?action=getMangaList");
    const data = await res.json();
    if(data.status==="success") mangaData = data.list;
  }catch(e){ console.error(e); }
}

// استدعاء عند تحميل الصفحة
fetchMangaList();

searchBox.addEventListener("input", ()=>{
  const val = searchBox.value.trim().toLowerCase();
  mangaListDiv.innerHTML = "";
  if(val.length===0) return;

  mangaData.forEach(item=>{
    if(item.name.toLowerCase().includes(val)){
      const div = document.createElement("div");
      div.className="manga-item";
      div.innerHTML = `<img src="${item.cover}" alt="غلاف">${item.name}`;
      div.onclick = ()=>{
        document.querySelectorAll(".manga-item").forEach(i=>i.classList.remove("selected"));
        div.classList.add("selected");
        selectedManga = item.name;
        searchBox.value = item.name;
        mangaListDiv.innerHTML="";
      };
      mangaListDiv.appendChild(div);
    }
  });
});

uploadBtn.addEventListener("click", async ()=>{
  if(!selectedManga){
    status.innerHTML="⚠️ اختر مانجا أولاً.";
    return;
  }
  const num = document.getElementById("chapterNumber").value.trim();
  const name = document.getElementById("chapterName").value.trim();
  const file = document.getElementById("chapterFile").files[0];
  if(!num || !name || !file){
    status.innerHTML="⚠️ الرجاء ملء كل الحقول.";
    return;
  }

  uploadBtn.disabled=true;
  status.innerHTML="⏳ جاري الرفع...";

  const reader = new FileReader();
  reader.onload = async (e)=>{
    const base64Data = e.target.result.split(",")[1];
    const payload = {
      action: "addChapter",
      manga: selectedManga,
      number: num,
      title: name,
      filename: file.name,
      file: base64Data
    };
    try{
      const res = await fetch("https://script.google.com/macros/s/AKfycbwHfgxQjwS2UplSvV63XSReQN0Jt-q3YcmlZQ8Zd64Q5lesALQ1_JqiUWxhfn76_mHQAQ/exec",{
        method:"POST",
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(data.status==="success"){
        status.innerHTML="✔️ تم رفع الفصل بنجاح.";
        document.getElementById("chapterNumber").value="";
        document.getElementById("chapterName").value="";
        document.getElementById("chapterFile").value="";
      }else{
        status.innerHTML="❌ خطأ: "+data.message;
      }
    }catch(e){
      status.innerHTML="❌ فشل الاتصال.";
      console.error(e);
    }
    uploadBtn.disabled=false;
  };
  reader.readAsDataURL(file);
});
</script>

</body>
</html>
