<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ | MangaSanctum</title>
<style>
body {
  font-family: "Segoe UI", Tahoma, sans-serif;
  background: radial-gradient(circle at top left, #1b1b2f, #151515);
  color: #eee;
  max-width: 900px;
  margin: 40px auto;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 0 25px rgba(0,0,0,0.4);
}
h1,h3 {color:#8ef;text-align:center;}
form {display:flex;flex-direction:column;gap:1rem;}
label {display:flex;flex-direction:column;gap:0.25rem;}
input,textarea,select {padding:0.5rem;border-radius:8px;border:none;background:#222;color:#fff;}
.row {display:flex;gap:1rem;flex-wrap:wrap;}
.col {flex:1;min-width:200px;}
.small {max-width:150px;}
button {
  padding:0.8rem;border:none;color:white;font-weight:bold;border-radius:10px;cursor:pointer;transition:0.3s;
}
button.saveBtn {background:linear-gradient(90deg,#5ac8fa,#007aff);}
button.saveBtn:hover {background:linear-gradient(90deg,#0af,#09f);}
button.deleteBtn {background:#f55;}
button.deleteBtn:hover {background:#f33;}
#msg {text-align:center;margin-top:1rem;font-size:0.95rem;}
.muted {color:#aaa;font-size:0.85rem;}
select.mangaSelect, select.chapterSelect {width:100%;padding:6px;margin-top:4px;background:#222;color:#fff;border-radius:6px;border:none;}
.section {border:1px solid #444;padding:15px;border-radius:12px;margin-bottom:20px;background:rgba(255,255,255,0.03);}
</style>
</head>
<body>

<h1>ğŸ“– Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ ÙˆØ§Ù„ÙØµÙˆÙ„</h1>

<div class="section">
<h3>Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ù†Ø¬Ø§ ÙˆÙØµÙ„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø­Ø°Ù</h3>
<label>Ø§Ù„Ù…Ø§Ù†Ø¬Ø§:
<select id="mangaSelect" class="mangaSelect">
  <option value="">-- Ø§Ø®ØªØ± Ù…Ø§Ù†Ø¬Ø§ --</option>
</select>
</label>

<label>Ø§Ù„ÙØµÙ„:
<select id="chapterSelect" class="chapterSelect">
  <option value="">-- Ø§Ø®ØªØ± ÙØµÙ„ --</option>
</select>
</label>

<div class="row">
<button type="button" id="deleteChapterBtn" class="deleteBtn">ğŸ—‘ Ø­Ø°Ù Ø§Ù„ÙØµÙ„</button>
<button type="button" id="deleteMangaBtn" class="deleteBtn">ğŸ—‘ Ø­Ø°Ù Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ ÙƒØ§Ù…Ù„Ø©</button>
</div>
</div>

<form id="mangaForm">
<h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø¬Ø§</h3>
<label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ø¬Ø§
<input type="text" id="mangaName" required />
</label>

<label>Ø§Ù„ÙˆØµÙ
<textarea id="mangaDesc" rows="4" placeholder="Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ù…Ø§Ù†Ø¬Ø§..."></textarea>
</label>

<div class="row">
<div class="col">
<label>Ø§Ù„ÙˆØ³ÙˆÙ… (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)
<input id="mangaTags" placeholder="Ù…Ø«Ø§Ù„: Ø´ÙˆÙ†ÙŠÙ†, Ø£ÙƒØ´Ù†, ÙƒÙˆÙ…ÙŠØ¯ÙŠØ§" />
</label>
</div>
<div class="col small">
<label>Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©
<select id="mangaAge">
<option value="all">All</option>
<option value="13+">13+</option>
<option value="16+">16+</option>
<option value="18+">18+</option>
</select>
</label>
</div>
</div>

<label>ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù (jpeg/png)
<input type="file" id="coverFile" accept="image/*" />
</label>

<h3>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ÙØµÙ„</h3>
<div class="row">
<div class="col small">
<label>Ø±Ù‚Ù… Ø§Ù„ÙØµÙ„
<input type="number" id="chapterNumber" value="1" min="1" required />
</label>
</div>
<div class="col">
<label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„
<input id="chapterTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„" />
</label>
</div>
</div>

<label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø± (UTC)
<input type="datetime-local" id="publishDate" />
<div class="muted">Ø§ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºÙ‹Ø§ Ù„ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ.</div>
</label>

<label>Ù…Ù„Ù Ø§Ù„ÙØµÙ„ (PDF)
<input type="file" id="chapterFile" accept="application/pdf" />
</label>

<div>
<button type="button" id="submitBtn" class="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ + Ø§Ù„ÙØµÙ„</button>
</div>
<p id="msg" class="muted"></p>
</form>

<script>
const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxTDVXojkUGOHD-9OZhmlP2qvGGUJO0UOpwevSYI1bdacpkAKLfZDS0lT7bcFWsiw32Ow/exec";

function $(id){return document.getElementById(id);}
function showMsg(msg,type="info"){$("msg").textContent=msg;$("msg").style.color=type==="error"?"#f66":type==="success"?"#6f6":"#aaa";}

async function fileToBase64(file){if(!file)return null;return new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result.split(",")[1]);fr.onerror=rej;fr.readAsDataURL(file);});}

async function collectForm(){
  const name=$("mangaName").value.trim();
  const desc=$("mangaDesc").value.trim();
  const tags=$("mangaTags").value.split(",").map(t=>t.trim()).filter(Boolean);
  const age=$("mangaAge").value;
  const cover=await fileToBase64($("coverFile").files[0]);
  const chapterNum=$("chapterNumber").value;
  const chapterTitle=$("chapterTitle").value.trim();
  const chapterFile=await fileToBase64($("chapterFile").files[0]);
  const publishDate=$("publishDate").value || new Date().toISOString();
  return {manga:{name,desc,tags,age,cover,createdAt:new Date().toISOString()}, chapter:{number:chapterNum,title:chapterTitle,publishDate,pdf:chapterFile}};
}

// ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø§Ù†Ø¬Ø§Øª
async function loadMangaList(){
  try{
    const res=await fetch(APP_SCRIPT_URL+"?action=list");
    const data=await res.json();
    const mangaSelect=$("mangaSelect");
    mangaSelect.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ù…Ø§Ù†Ø¬Ø§ --</option>';
    for(const m of data.mangas){
      const opt=document.createElement("option");
      opt.value=m.name; opt.textContent=m.name;
      mangaSelect.appendChild(opt);
    }
  }catch(e){showMsg("Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§Øª: "+e,"error");}
}

// Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ù†Ø¬Ø§
$("mangaSelect").addEventListener("change",async()=>{
  const mangaName=$("mangaSelect").value;
  const chapterSelect=$("chapterSelect");
  chapterSelect.innerHTML='<option value="">-- Ø§Ø®ØªØ± ÙØµÙ„ --</option>';
  if(!mangaName) return;
  try{
    const res=await fetch(APP_SCRIPT_URL+"?action=get&manga="+encodeURIComponent(mangaName));
    const data=await res.json();
    $("mangaName").value=data.name||"";
    $("mangaDesc").value=data.description||"";
    $("mangaTags").value=(data.tags||[]).join(",");
    $("mangaAge").value=data.age||"all";
    (data.chapters||[]).forEach(ch=>{
      const opt=document.createElement("option");
      opt.value=ch.number; opt.textContent="Ch"+ch.number+" - "+ch.title;
      chapterSelect.appendChild(opt);
    });
  }catch(e){showMsg("Ø®Ø·Ø£ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø¬Ø§: "+e,"error");}
});

// Ø§Ø®ØªÙŠØ§Ø± ÙØµÙ„ Ù„ØªØ­Ø±ÙŠØ±
$("chapterSelect").addEventListener("change",()=>{
  const chNum=$("chapterSelect").value;
  if(!chNum) return;
  $("chapterNumber").value=chNum;
  $("chapterTitle").value=$("chapterSelect").selectedOptions[0].textContent.split(" - ")[1]||"";
});

// Ø­ÙØ¸ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„
$("submitBtn").addEventListener("click",async()=>{
  try{
    showMsg("ÙŠØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ±... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±");
    const payload=await collectForm();
    const res=await fetch(APP_SCRIPT_URL,{
      method:"POST",
      headers: {'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const data=await res.json();
    if(data.success) showMsg("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§/Ø§Ù„ÙØµÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…","success");
    else showMsg("Ø­Ø¯Ø« Ø®Ø·Ø£: "+(data.error||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),"error");
    $("mangaForm").reset();
    await loadMangaList();
  }catch(e){showMsg("Ø­Ø¯Ø« Ø®Ø·Ø£: "+e,"error");}
});

// Ø­Ø°Ù ÙØµÙ„
$("deleteChapterBtn").addEventListener("click",async()=>{
  const manga=$("mangaSelect").value;
  const ch=$("chapterSelect").value;
  if(!manga||!ch){showMsg("Ø§Ø®ØªØ± Ù…Ø§Ù†Ø¬Ø§ ÙˆÙØµÙ„ Ù„Ù„Ø­Ø°Ù","error"); return;}
  try{
    const res=await fetch(APP_SCRIPT_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:"deleteChapter",manga,ch})
    });
    const data=await res.json();
    if(data.success) showMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØµÙ„ âœ…","success");
    else showMsg("Ø®Ø·Ø£: "+(data.error||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),"error");
    await loadMangaList();
  }catch(e){showMsg("Ø­Ø¯Ø« Ø®Ø·Ø£: "+e,"error");}
});

// Ø­Ø°Ù Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ ÙƒØ§Ù…Ù„Ø©
$("deleteMangaBtn").addEventListener("click",async()=>{
  const manga=$("mangaSelect").value;
  if(!manga){showMsg("Ø§Ø®ØªØ± Ù…Ø§Ù†Ø¬Ø§ Ù„Ù„Ø­Ø°Ù","error"); return;}
  try{
    const res=await fetch(APP_SCRIPT_URL,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:"deleteManga",manga})
    });
    const data=await res.json();
    if(data.success) showMsg("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ ÙƒØ§Ù…Ù„Ø© âœ…","success");
    else showMsg("Ø®Ø·Ø£: "+(data.error||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),"error");
    $("mangaForm").reset();
    await loadMangaList();
  }catch(e){showMsg("Ø­Ø¯Ø« Ø®Ø·Ø£: "+e,"error");}
});

// ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
loadMangaList();
</script>
</body>
</html>
