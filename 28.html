<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>إضافة فصل | MangaSanctum</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  /* (نفس CSS الذي تستخدمه) */
  body{margin:0;padding:0;background:radial-gradient(circle at top,#1c1b29,#0e0d16);font-family:"Segoe UI",sans-serif;color:#eee;display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding-top:20px}
  .container{width:95%;max-width:650px;padding:20px;backdrop-filter:blur(18px);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:18px;box-shadow:0 0 25px rgba(120,80,255,0.25);animation:fadein 0.6s ease}
  @keyframes fadein{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
  h1{text-align:center;color:#bbaaff;font-weight:normal;font-size:1.6em;}
  #searchBox{width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:10px;color:#eee;margin-bottom:12px;}
  #mangaList{max-height:250px;overflow-y:auto;margin-bottom:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.12);}
  .manga-item{padding:8px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:0.2s;}
  .manga-item:hover{background:rgba(140,120,255,0.15);}
  .manga-item.selected{background:rgba(140,120,255,0.3);}
  .manga-item img{width:50px;height:65px;border-radius:6px;object-fit:cover;flex-shrink:0;}
  label{display:block;margin-top:15px;font-size:0.9em;}
  input,textarea{width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:10px;color:#eee;margin-top:8px;transition:0.3s;font-size:0.9em;}
  input:focus,textarea:focus{border-color:#8b70ff;box-shadow:0 0 0 3px rgba(140,120,255,0.25);outline:none;}
  button{width:100%;margin-top:25px;padding:12px;font-size:17px;background:linear-gradient(135deg,#7d5cff,#6140ff);border:none;border-radius:12px;color:#fff;cursor:pointer;transition:0.3s;font-weight:bold;}
  button:disabled{opacity:0.4;cursor:not-allowed;}
  #status{margin-top:15px;text-align:center;color:#ccbaff;font-size:0.9em;}
</style>
</head>
<body>
<div class="container">
  <h1>إضافة فصل جديد</h1>

  <input id="searchBox" type="text" placeholder="ابحث عن المانجا">
  <div id="mangaList"></div>

  <label>رقم الفصل</label>
  <input id="chapterNumber" type="text">

  <label>عنوان الفصل (اختياري)</label>
  <input id="chapterName" type="text">

  <label>ملف الفصل (PDF / ZIP / DOCX / صور...)</label>
  <input id="chapterFile" type="file" id="fileInput">

  <button id="uploadBtn">رفع الفصل</button>
  <div id="status"></div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzUo8wFTsVospLc7Rg8GRhW0A0LWvrfns7cq8ivHwk9obxj3uYlBerk8v6eDPTjM_QM/exec"; // <-- غيّر هذا
let mangaData = [];
let selectedManga = null;

const mangaListDiv = document.getElementById("mangaList");
const searchBox = document.getElementById("searchBox");
const uploadBtn = document.getElementById("uploadBtn");
const statusDiv = document.getElementById("status");
const chapterFileInput = document.getElementById("chapterFile");

// تحويل رابط Google Drive إلى رابط مباشر
function convertDriveLink(url){
  if(!url) return "";
  let match1 = url.match(/\/d\/(.*?)\/view/);
  if(match1 && match1[1]) return `https://lh3.googleusercontent.com/d/${match1[1]}`;
  let match2 = url.match(/id=([a-zA-Z0-9_-]+)/);
  if(match2 && match2[1]) return `https://lh3.googleusercontent.com/d/${match2[1]}`;
  return url;
}

// البحث الفوري (محمي ضد undefined)
searchBox.addEventListener("input", ()=>{
  const val = searchBox.value.trim().toLowerCase();
  mangaListDiv.innerHTML = "";
  if(val.length === 0) return;

  mangaData.forEach(item=>{
    if(!item) return;
    let name = typeof item === "string" ? item : item.name;
    let cover = typeof item === "string" ? "" : item.cover;
    if(!name || typeof name !== "string") return;
    if(name.toLowerCase().includes(val)){
      const div = document.createElement("div");
      div.className = "manga-item";
      if(cover){
        const direct = convertDriveLink(cover);
        div.innerHTML = `<img src="${direct}" alt="غلاف"><span>${name}</span>`;
      } else {
        div.innerHTML = `<span>${name}</span>`;
      }
      div.onclick = ()=>{
        document.querySelectorAll(".manga-item").forEach(i=>i.classList.remove("selected"));
        div.classList.add("selected");
        selectedManga = name;
        searchBox.value = name;
        mangaListDiv.innerHTML = "";
      };
      mangaListDiv.appendChild(div);
    }
  });
});

// جلب قائمة المانجا عند التحميل
fetch(GAS_URL + "?action=getMangaList")
  .then(r=>r.json())
  .then(data=>{
    if(data && Array.isArray(data.list)) mangaData = data.list;
    else console.warn("البيانات خاطئة من السكربت:", data);
  })
  .catch(err=>console.error("خطأ في جلب المانجا:", err));

// دالة مساعدة لقراءة الملف كـ dataURL (Base64)
function readFileAsDataURL(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onerror = () => { fr.abort(); reject(new Error("فشل قراءة الملف")); };
    fr.onload = () => resolve(fr.result);
    fr.readAsDataURL(file);
  });
}

// رفع الفصل: نقرأ الملف كـ base64 ثم نرسله داخل JSON
uploadBtn.addEventListener("click", async ()=>{
  if(!selectedManga){
    statusDiv.innerHTML = "⚠️ اختر مانجا أولاً";
    return;
  }

  const num = document.getElementById("chapterNumber").value.trim();
  const title = document.getElementById("chapterName").value.trim();
  const file = chapterFileInput.files[0];

  if(!num || !file){
    statusDiv.innerHTML = "⚠️ الرجاء ملء رقم الفصل واختيار الملف";
    return;
  }

  uploadBtn.disabled = true;
  statusDiv.innerHTML = "⏳ جاري تحويل الملف وإرساله...";

  try {
    // اقرأ الملف كـ data URL -> "data:<mime>;base64,AAAA..."
    const dataUrl = await readFileAsDataURL(file);
    const commaIndex = dataUrl.indexOf(",");
    const meta = dataUrl.substring(5, commaIndex); // e.g. "image/png;base64"
    const base64Data = dataUrl.substring(commaIndex + 1);
    const mime = meta.split(";")[0] || file.type || "application/octet-stream";

    // جهّز الحمولة JSON
    const payload = {
      action: "addChapter",
      manga: selectedManga,
      number: num,
      title: title || "",
      fileName: file.name,
      mimeType: mime,
      fileBase64: base64Data
    };

    const res = await fetch(https://script.google.com/macros/s/AKfycbzUo8wFTsVospLc7Rg8GRhW0A0LWvrfns7cq8ivHwk9obxj3uYlBerk8v6eDPTjM_QM/exec, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if(data.status === "success"){
      statusDiv.innerHTML = "✔️ تم رفع الفصل بنجاح!";
      document.getElementById("chapterNumber").value = "";
      document.getElementById("chapterName").value = "";
      chapterFileInput.value = "";
    } else {
      statusDiv.innerHTML = "❌ خطأ: " + (data.message || "غير معروف");
    }
  } catch (err) {
    console.error(err);
    statusDiv.innerHTML = "❌ حدث خطأ أثناء الرفع";
  } finally {
    uploadBtn.disabled = false;
  }
});
</script>
</body>
</html>
